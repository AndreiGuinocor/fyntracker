<!-- usermanagement.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Management - FynTracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <!-- Guard: redirect guests -->
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm sticky-top">
    <div class="container">
      <a id="brandLink" class="navbar-brand fw-bold" href="dashboard.html">FynTracker</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto" id="navLinks"></ul>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <main class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">User Management</h1>
      <!-- this triggers the Add User modal -->
      <button id="openAddUserBtn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        Add New User
      </button>
    </div>

    <div class="card shadow-sm p-3">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">#</th>
            <th scope="col">Full Name</th>
            <th scope="col">Email</th>
            <th scope="col">Role</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <!-- rendered by JS -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="addUserForm" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="addUserAlert" class="alert alert-danger d-none" role="alert"></div>

            <div class="mb-3">
              <label for="userFullName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="userFullName" placeholder="e.g. Maria Santos" required>
              <div class="invalid-feedback">Please enter full name.</div>
            </div>

            <div class="mb-3">
              <label for="userEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="userEmail" placeholder="email@example.com" required>
              <div class="invalid-feedback">Please enter a valid email.</div>
            </div>

            <div class="mb-3">
              <label for="userRole" class="form-label">Role</label>
              <select id="userRole" class="form-select" required>
                <option value="">Select role</option>
                <option value="User">User</option>
                <option value="Admin">Admin</option>
              </select>
              <div class="invalid-feedback">Please select role.</div>
            </div>

            <!-- NOTE: demo only — do not store real passwords in localStorage for production -->
            <div class="mb-3">
              <label for="userPassword" class="form-label">Password (demo only)</label>
              <input type="password" class="form-control" id="userPassword" placeholder="temporary password">
              <div class="form-text">This is a demo app. Do not use real passwords here.</div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-light text-center py-3 mt-5">
    <div class="container"><small>&copy; 2025 FynTracker. All rights reserved.</small></div>
  </footer>

  <!-- Scripts: bootstrap, nav.js, and page script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/nav.js"></script>

  <script>
  // usermanagement page script (loads after nav.js)
  (function () {
    const STORAGE_KEY = 'fyn_users';
    const tableBody = document.getElementById('usersTableBody');
    const addUserForm = document.getElementById('addUserForm');
    const addUserModalEl = document.getElementById('addUserModal');
    const addUserAlert = document.getElementById('addUserAlert');
    const bsAddUserModal = new bootstrap.Modal(addUserModalEl);

    // get users array from localStorage OR provide default sample users
    function getUsers() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          // seed some sample users (only first-time)
          const sample = [
            { id: 1, name: 'Maria Santos', email: 'maria@example.com', role: 'User', createdAt: '2025-01-10' },
            { id: 2, name: 'Daniel Kim', email: 'daniel@example.com', role: 'Admin', createdAt: '2025-02-04' }
          ];
          localStorage.setItem(STORAGE_KEY, JSON.stringify(sample));
          return sample;
        }
        return JSON.parse(raw);
      } catch (err) {
        console.error('Failed to parse users', err);
        return [];
      }
    }

    function saveUsers(users) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
    }

    // create next id
    function nextId(users) {
      if (!users || users.length === 0) return 1;
      return Math.max(...users.map(u => u.id)) + 1;
    }

    // render users table
    function renderUsers() {
      const users = getUsers();
      if (!tableBody) return;
      if (users.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users yet.</td></tr>';
        return;
      }

      tableBody.innerHTML = users.map(u => `
        <tr>
          <th scope="row">${u.id}</th>
          <td>${escapeHtml(u.name)}</td>
          <td>${escapeHtml(u.email)}</td>
          <td>${escapeHtml(u.role)}</td>
          <td>
            <a href="user-record.html?id=${u.id}" class="btn btn-sm btn-outline-primary">View</a>
            <button class="btn btn-sm btn-outline-secondary" data-action="edit" data-id="${u.id}">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${u.id}">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // basic HTML escape to prevent accidental injection in this demo
    function escapeHtml(s) {
      if (!s) return '';
      return s.replaceAll('&', '&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    // handle form submit (add user)
    addUserForm.addEventListener('submit', function (e) {
      e.preventDefault();
      addUserAlert.classList.add('d-none');

      // form fields
      const name = document.getElementById('userFullName').value.trim();
      const email = document.getElementById('userEmail').value.trim().toLowerCase();
      const role = document.getElementById('userRole').value;
      const password = document.getElementById('userPassword').value; // demo only

      // simple validation
      if (!name || !email || !role) {
        addUserAlert.textContent = 'Please fill out name, email and role.';
        addUserAlert.classList.remove('d-none');
        return;
      }
      // email regex (simple)
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        addUserAlert.textContent = 'Please enter a valid email address.';
        addUserAlert.classList.remove('d-none');
        return;
      }

      // check duplicate email
      const users = getUsers();
      if (users.some(u => u.email === email)) {
        addUserAlert.textContent = 'A user with this email already exists.';
        addUserAlert.classList.remove('d-none');
        return;
      }

      // create user object (demo: storing createdAt, not storing password securely)
      const newUser = {
        id: nextId(users),
        name,
        email,
        role,
        createdAt: new Date().toISOString().slice(0,10),
        // password: password // optional - do NOT use in production
      };

      users.push(newUser);
      saveUsers(users);
      renderUsers();

      // reset & close modal
      addUserForm.reset();
      bsAddUserModal.hide();
    });

    // delegate edit / delete buttons (we will implement delete now but edit later)
    document.querySelector('.card').addEventListener('click', function (e) {
      const btn = e.target.closest('button, a');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id && parseInt(btn.dataset.id, 10);
      if (!action || !id) return;

      if (action === 'delete') {
        if (!confirm('Delete this user? This cannot be undone.')) return;
        let users = getUsers();
        users = users.filter(u => u.id !== id);
        saveUsers(users);
        renderUsers();
      }

      if (action === 'edit') {
        // placeholder — we'll implement step-by-step later
        alert('Edit user (coming next). User id: ' + id);
      }
    });

    // initial render on page load
    document.addEventListener('DOMContentLoaded', function () {
      renderUsers();
    });
  })();
  </script>
</body>
</html>
